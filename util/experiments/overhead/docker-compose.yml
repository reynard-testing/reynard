x-common-configs:
  sysctls-setup: &sysctls-common
    sysctls:
      - net.ipv4.tcp_tw_reuse=1
      - net.ipv4.tcp_max_tw_buckets=65536
      - net.ipv4.ip_local_port_range=1024 65535
      - net.ipv4.tcp_synack_retries=2
      - net.ipv4.tcp_fin_timeout=15

services:
  target:
    <<: *sysctls-common
    build: ./target-svc
    networks:
      - external_benchmark_net

  proxy:
    <<: *sysctls-common
    image: "${PROXY_IMAGE:-fit-proxy:latest}"
    environment:
      - OTEL_SDK_ENABLED=false
      - PROXY_HOST=0.0.0.0:8080
      - PROXY_TARGET=http://target:8080
      - SERVICE_NAME=target
      - CONTROLLER_HOST
      - LOG_LEVEL
      # - USE_PPROF=true
    networks:
      - external_benchmark_net

  controller:
    <<: *sysctls-common
    ports:
      - "5050:5000" # Expose control port
    image: "${CONTROLLER_IMAGE:-fit-controller:latest}"
    environment:
      - OTEL_SDK_ENABLED=false
      - LOG_LEVEL
    networks:
      - external_benchmark_net

  controller-dummy:
    <<: *sysctls-common
    build: ./target-svc
    networks:
      - external_benchmark_net

networks:
  external_benchmark_net:
    external: true
    name: reynard_benchmark_net
